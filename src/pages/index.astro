---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";
import { SOCIALS } from "@/constants";
import Skills from "@/components/sections/Skills.astro";
import Experience from "@/components/sections/Experience.astro";
import Projects from "@/components/sections/Projects.astro";
import Achievements from "@/components/sections/Achievements.astro";
import IntroAudio from "@/components/IntroAudio.astro";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);
---

<Layout>
  <Header />

  <main id="main-content" data-layout="index" class="relative app-layout">
    <!-- ═══════════════════ HERO ═══════════════════ -->
    <section id="hero" class="hero-section relative pt-10 pb-14 sm:pt-14 sm:pb-20">
      <div class="relative z-10 flex flex-col-reverse gap-8 sm:flex-row sm:items-start sm:justify-between">
        <!-- Left: text -->
        <div class="flex-1">
          <!-- Terminal prompt badge -->
          <div class="mb-3 inline-flex items-center gap-2 rounded-full border border-border/40 bg-muted/20 px-3.5 py-1.5 font-cartograph text-xs sm:text-sm">
            <span class="relative flex h-2 w-2">
              <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-accent opacity-60"></span>
              <span class="relative inline-flex h-2 w-2 rounded-full bg-accent"></span>
            </span>
            <span class="text-accent">~</span>/senior-backend-engineer
            <span class="opacity-40">$</span>
          </div>

          <!-- Name -->
          <h1 class="hero-title mb-2 text-5xl leading-[1.1] font-bold tracking-tight sm:text-6xl lg:text-7xl">
            Nguyễn Mạnh Hùng
            <a
              target="_blank"
              href="/rss.xml"
              class="ml-1 inline-block align-middle"
              aria-label="RSS feed"
              title="RSS Feed"
            >
              <IconRss
                width={22}
                height={22}
                class="stroke-accent stroke-3 opacity-40 transition-opacity duration-300 hover:opacity-100"
              />
            </a>
          </h1>

          <!-- Role / tagline -->
          <p class="mb-1 font-cartograph text-base text-accent sm:text-lg">
            Senior Backend Engineer @ Nokia FNMS · TP. Hồ Chí Minh
          </p>

          <!-- Bio -->
          <p class="mt-4 max-w-xl text-base leading-relaxed opacity-75 sm:text-lg">
            Xây dựng hệ thống có thể mở rộng, dạy lại những gì tôi học được.
            Đam mê competitive programming, AI và tự động hóa mọi thứ có thể tự động hóa.
          </p>

          <!-- Audio + Social links -->
          <div class="mt-6 flex flex-col gap-4">
            {SITE.introAudio.enabled && (
              <IntroAudio
                src={SITE.introAudio.src}
                label={SITE.introAudio.label}
                duration={SITE.introAudio.duration}
              />
            )}
            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
              <p class="text-sm opacity-50 flex-shrink-0">Kết nối với tôi</p>
              {SOCIALS.length > 0 && (
                <div class="sm:border-l border-border/40 sm:pl-4">
                  <Socials />
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Right: avatar -->
        <div class="flex-shrink-0 self-center sm:self-start">
          <div class="avatar-ring">
            <img
              src="/avatar.png"
              alt="Nguyễn Mạnh Hùng"
              width="120"
              height="120"
              class="avatar-img"
            />
          </div>
        </div>
      </div>
    </section>

    <!-- ═══════════════════ ABOUT ═══════════════════ -->
    <section id="about" class="py-10">
      <div class="mb-6 flex items-center gap-3">
        <h2 class="text-sm font-bold tracking-widest text-accent uppercase">Về tôi</h2>
        <div class="h-px flex-1 bg-border/20"></div>
        <LinkButton
          href="/about"
          class="font-cartograph text-xs text-muted-foreground hover:text-accent transition-colors"
        >
          Chi tiết →
        </LinkButton>
      </div>
      <div class="max-w-2xl space-y-3 text-sm text-muted-foreground leading-relaxed sm:text-base">
        <p>
          Tôi là Software Engineer với nền tảng mạnh về <strong class="text-foreground">Java &amp; Spring Boot</strong>,
          hiện đang làm việc tại <strong class="text-foreground">Nokia</strong> trong dự án Fixed Network Management System (FNMS) —
          phần mềm quản lý mạng viễn thông doanh nghiệp quy mô lớn.
        </p>
        <p>
          Bên cạnh công việc, tôi đam mê <strong class="text-foreground">competitive programming</strong>
          (ICPC, Meta Hacker Cup), nghiên cứu AI thực dụng (ComfyUI, Local LLM, automation),
          và đang theo học <strong class="text-foreground">MBA tại UEH</strong> để phát triển tư duy kinh doanh.
        </p>
        <p>
          Blog này là nơi tôi chia sẻ những gì học được — từ system design, Java internals, đến triết học về trí tuệ và năng suất.
        </p>
      </div>
    </section>

    <!-- ═══════════════════ SKILLS ═══════════════════ -->
    <Skills />

    <!-- ═══════════════════ EXPERIENCE ═══════════════════ -->
    <Experience />

    <!-- ═══════════════════ PROJECTS ═══════════════════ -->
    <Projects />

    <!-- ═══════════════════ ACHIEVEMENTS ═══════════════════ -->
    <Achievements />

    <!-- ═══════════════════ FEATURED POSTS ═══════════════════ -->
    {featuredPosts.length > 0 && (
      <section id="featured" class="py-10">
        <div class="mb-6 flex items-center gap-3">
          <h2 class="flex items-center gap-2 text-sm font-bold tracking-widest text-accent uppercase">
            <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
            Bài viết nổi bật
          </h2>
          <div class="h-px flex-1 bg-border/20"></div>
        </div>
        <ul class="grid gap-4 sm:grid-cols-2 [&>li]:my-0">
          {featuredPosts.map(data => (
            <Card variant="h3" featured={true} {...data} />
          ))}
        </ul>
      </section>
    )}

    <!-- ═══════════════════ RECENT POSTS ═══════════════════ -->
    {recentPosts.length > 0 && (
      <section id="recent-posts" class="py-6 pb-10">
        <div class="mb-6 flex items-center gap-3">
          <h2 class="text-sm font-bold tracking-widest uppercase">Bài viết gần đây</h2>
          <div class="h-px flex-1 bg-border/20"></div>
          <span class="font-cartograph text-xs text-accent/40 select-none">
            [{recentPosts.slice(0, SITE.postPerIndex).length}/{recentPosts.length}]
          </span>
        </div>
        <ul>
          {recentPosts.map(
            (data, index) =>
              index < SITE.postPerIndex && <Card variant="h3" {...data} />
          )}
        </ul>

        <div class="mt-8 mb-4 flex justify-center w-full">
          <LinkButton
            href="/posts/"
            class="group inline-flex items-center w-full sm:w-auto justify-center gap-2 rounded-xl border border-accent/20 bg-accent/10 px-8 py-4 text-base font-bold text-accent transition-all duration-300 hover:border-accent hover:bg-accent/20 hover:shadow-xl hover:shadow-accent/20 hover:-translate-y-0.5"
          >
            Xem tất cả bài viết
            <IconArrowRight class="inline-block transition-transform duration-300 group-hover:translate-x-1 rtl:-rotate-180" />
          </LinkButton>
        </div>
      </section>
    )}
  </main>
  <Footer />
</Layout>

<style>
  .hero-title {
    background: linear-gradient(
      135deg,
      var(--accent) 0%,
      color-mix(in oklab, var(--accent) 50%, var(--foreground)) 20%,
      var(--foreground) 35%,
      var(--foreground) 65%,
      color-mix(in oklab, var(--accent) 50%, var(--foreground)) 80%,
      var(--accent) 100%
    );
    background-size: 250% auto;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 6s ease-in-out infinite;
  }

  @keyframes shimmer {
    0%, 100% { background-position: 0% center; }
    50% { background-position: 100% center; }
  }

  .avatar-ring {
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    padding: 3px;
    background: linear-gradient(
      135deg,
      var(--accent),
      color-mix(in oklab, var(--accent) 40%, transparent)
    );
    box-shadow: 0 0 24px -4px color-mix(in oklab, var(--accent) 40%, transparent);
  }

  .avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--background);
  }

  @media (min-width: 640px) {
    .avatar-ring {
      width: 140px;
      height: 140px;
    }
  }
</style>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }

    document.querySelectorAll<HTMLElement>(".card-glow").forEach(card => {
      card.addEventListener("mousemove", (e: MouseEvent) => {
        const rect = card.getBoundingClientRect();
        card.style.setProperty("--mouse-x", `${e.clientX - rect.left}px`);
        card.style.setProperty("--mouse-y", `${e.clientY - rect.top}px`);
      });
    });
  });
</script>
